# Modifications Copyright (C) 2025 Advanced Micro Devices, Inc. All rights reserved.
# Portions of this file consist of AI-generated content.
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

# AUP Learning Cloud - Default Configuration
#
# Deploy with:
#   helm install jupyterhub ./jupyterhub -n jupyterhub --create-namespace -f values.yaml

# Authentication mode: "auto-login" | "dummy" | "github" | "multi"
#   - auto-login: No credentials required, auto-login as 'student' (default, for single-node)
#   - dummy: Accept any username/password (for testing)
#   - github: GitHub OAuth authentication
#   - multi: GitHub OAuth + Local accounts
#
# Auto-create admin user on first install (optional)
# When enabled, helm install will:
# 1. Generate random API token and admin password
# 2. Store them in jupyterhub-admin-credentials secret
# 3. Auto-configure admin user on hub startup
# To get credentials after install:
#   kubectl -n jupyterhub get secret jupyterhub-admin-credentials -o jsonpath='{.data.admin-password}' | base64 -d
#   kubectl -n jupyterhub get secret jupyterhub-admin-credentials -o jsonpath='{.data.api-token}' | base64 -d
custom:
  authMode: "auto-login"
  adminUser:
    enabled: false  # Set to true to enable auto-admin creation

  # Accelerator configuration (GPU/NPU nodes)
  # This centralizes all accelerator info: display, node selector, env, quota rate
  accelerators:
    # GPU accelerators
    phx:
      displayName: "AMD Radeon™ 780M (Phoenix Point iGPU)"
      description: "RDNA 3.0 (gfx1103) | Compute Units 12 | 4GB LPDDR5X"
      nodeSelector:
        node-type: phx
      env:
        HSA_OVERRIDE_GFX_VERSION: "11.0.0"
      quotaRate: 2
    strix:
      displayName: "AMD Radeon™ 890M (Strix Point iGPU)"
      description: "RDNA 3.5 (gfx1150) | Compute Units 16 | 4GB LPDDR5X"
      nodeSelector:
        node-type: strix
      env: {}
      quotaRate: 2
    strix-halo:
      displayName: "AMD Radeon™ 8060S (Strix Halo iGPU)"
      description: "RDNA 3.5 (gfx1151) | Compute Units 40 | 64GB LPDDR5X"
      nodeSelector:
        node-type: strix-halo
      env: {}
      quotaRate: 3
    dgpu:
      displayName: "AMD Radeon™ 9070XT (Desktop GPU)"
      description: "RDNA 4.0 (gfx1201) | Compute Units 64 | 16GB GDDR6"
      nodeSelector:
        node-type: dgpu
      env: {}
      quotaRate: 4
    # NPU accelerators (note: uses "type" label, not "node-type")
    strix-npu:
      displayName: "AMD XDNA2 (Strix Point NPU)"
      description: "AMD XDNA2 NPU with AI acceleration"
      nodeSelector:
        type: strix
      env: {}
      quotaRate: 1

  # User quota management system
  # Quota controls container usage time (quota units consumed per minute)
  quota:
    # Enable/disable quota system (auto-disabled for auto-login/dummy modes if not set)
    enabled: null  # null = auto-detect based on authMode

    # CPU-only quota rate (when no accelerator selected)
    cpuRate: 1

    # Minimum quota required to start any container
    minimumToStart: 10

    # Default quota for new users
    # When a new user first attempts to use the system, they will be automatically
    # granted this amount of quota if they don't have unlimited status
    defaultQuota: 0

    # Grant unlimited quota to new users by default
    # If true, new users will have unlimited quota (overrides defaultQuota)
    defaultUnlimited: false

    # Admin users have unlimited quota (no quota deduction)
    adminsUnlimited: true

    # List of usernames with unlimited quota (case-insensitive)
    unlimitedUsers: []
    # Example:
    # unlimitedUsers:
    #   - instructor1
    #   - researcher1

    # Auto-refresh rules: each rule generates a K8s CronJob
    #
    # Action modes:
    #   add: Add amount to current balance (default). Use negative for deduction.
    #   set: Set balance to exact amount
    #
    # Targets support flexible filtering:
    #   includeUnlimited: bool - include unlimited users (default: false)
    #   balanceBelow: int - only if balance < this value
    #   balanceAbove: int - only if balance > this value
    #   includeUsers: list - only these users
    #   excludeUsers: list - exclude these users
    #   usernamePattern: str - regex pattern for username matching
    refreshRules: {}
    # Example:
    # refreshRules:
    #   daily-topup:
    #     enabled: true
    #     schedule: "0 0 * * *"
    #     action: add              # add (default) / set
    #     amount: 100              # positive = add, negative = deduct
    #     maxBalance: 500          # cap (for positive add)
    #     minBalance: 0            # floor (for negative add)
    #     targets:
    #       includeUnlimited: false
    #       balanceBelow: 400
    #   monthly-reset:
    #     enabled: true
    #     schedule: "0 0 1 * *"
    #     action: set              # set everyone to 500
    #     amount: 500
    #     targets:
    #       includeUnlimited: false
    #   weekly-decay:
    #     enabled: false
    #     schedule: "0 0 * * 0"
    #     amount: -50              # negative = deduct 50 each week
    #     minBalance: 0
    #     targets:
    #       balanceAbove: 100

# Use K3s built-in local-path storage (no NFS required)
hub:
  # Service account for quota refresh CronJob
  services:
    quota-refresh:
      admin: true
      # apiToken will be auto-generated by z2jh

  db:
    pvc:
      storageClassName: local-path
  image:
    name: ghcr.io/amdresearch/auplc-hub
    tag: latest
    pullPolicy: IfNotPresent

  extraConfig:
    01-api-token: |
      import os
      api_token = os.environ.get('JUPYTERHUB_API_TOKEN')
      if api_token:
          c.JupyterHub.api_tokens = {api_token: "admin"}
          print("✅ API token loaded for admin user")

    02-templates-and-static: |
      import os
      template_path = os.environ.get('JUPYTERHUB_TEMPLATE_PATH', '/tmp/custom_templates')
      c.JupyterHub.template_paths = [template_path]

    03-auto-create-admin: |
      import os
      import dbm
      import bcrypt

      admin_password = os.environ.get('JUPYTERHUB_ADMIN_PASSWORD', '')
      admin_username = 'admin'

      # Set admin user
      if admin_password:
          c.Authenticator.admin_users = {admin_username}
          print(f"✅ Admin user configured: {admin_username}")

          passwords_dbm = '/srv/jupyterhub/passwords.dbm'
          try:
              with dbm.open(passwords_dbm, 'r') as db:
                  if admin_username in db:
                      print(f"✅ Admin '{admin_username}' password already set")
                      admin_password = None
          except:
              pass

          if admin_password:
              with dbm.open(passwords_dbm, 'c', 0o600) as db:
                  db[admin_username] = bcrypt.hashpw(admin_password.encode(), bcrypt.gensalt())
              print(f"✅ Admin '{admin_username}' password set automatically")

    04-hide-logout-for-autologin: |
      # Hide logout button in auto-login mode
      if AUTH_MODE == "auto-login":
          c.JupyterHub.template_vars = {"hide_logout": True}
          print("[INFO] Auto-login mode: logout button hidden")

  extraFiles:
    announcement.txt:
    # If you want to edit the notice on login.html, change here.
      mountPath: /usr/local/share/jupyterhub/static/announcement.txt
      stringData: |
          <div class="announcement-box" style="padding: 1em; border: 1px solid #ccc; border-radius: 6px; background-color: #f8f8f8;">
          <h3>Welcome to AUP Learning Cloud!</h3>
          <p>This is a <strong>dynamic announcement</strong>.</p>
          <p>My location is on <code>runtime/values.yaml</code></p>
          <p>You can edit this via <strong>ConfigMap</strong> without rebuilding the image.</p>
          </div>

  # Environment variables from secrets (for auto-admin feature)
  extraEnv:
    - name: JUPYTERHUB_API_TOKEN
      valueFrom:
        secretKeyRef:
          name: jupyterhub-admin-credentials
          key: api-token
          optional: true
    - name: JUPYTERHUB_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: jupyterhub-admin-credentials
          key: admin-password
          optional: true

  config:
    # ---- Hub Core ----
    # JupyterHub:
      # Enable JupyterHub REST API
      # API Documentation: https://jupyterhub.readthedocs.io/en/stable/reference/rest-api.html
      # api_tokens:
      #   Configure API tokens for external services
      #   Format: token: username
      #   It's recommended to use environment variables or secrets to manage tokens
      #   Example: "your-secure-api-token-here": "admin-service"

    Authenticator:
      allow_all: true

    # ---- GitHub OAuth ----
    GitHubOAuthenticator:
      oauth_callback_url: "https://<Your.domain>/hub/github/oauth_callback"
      client_id: "TODO"
      client_secret: "TODO"
      allowed_organizations:
        - <YOUR-ORG-NAME>
      scope:
        - read:user
        - read:org

    # ---- KubeSpawner Prepuller Setup ----
    KubeSpawner:
      image_pull_policy: IfNotPresent

singleuser:
  storage:
    dynamic:
      storageClass: local-path

# Use NodePort for direct access
proxy:
  service:
    type: NodePort
    nodePorts:
      http: 30890

# Disable ingress (use NodePort instead)
ingress:
  enabled: false

# Disable prePuller for faster deployment
# Images will be pulled on-demand when users spawn notebooks
prePuller:
  hook:
    enabled: false
  continuous:
    enabled: false
