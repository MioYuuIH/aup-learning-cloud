# Modifications Copyright (C) 2025 Advanced Micro Devices, Inc. All rights reserved.
# Portions of this file consist of AI-generated content.
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

# AUP Learning Cloud - Deployment Configuration
#
# Deploy with:
#   helm install jupyterhub ./chart -n jupyterhub --create-namespace -f values.yaml
#
# This file contains environment-specific overrides.
# See chart/values.yaml for all available options and defaults.
#
# ============================================================================
# Course Management Guide
# ============================================================================
# Add a new course:
#   1. Add course image in custom.resources.images
#   2. Add resource requirements in custom.resources.requirements
#   3. Add team access permissions in custom.teams.mapping
#
# Modify a course:
#   - Change image address or tag in images
#   - Adjust CPU/memory/GPU settings in requirements
#
# Add a new accelerator:
#   - Add new GPU/NPU node type in custom.accelerators
# ============================================================================

custom:
  # Authentication mode
  # - auto-login: No credentials required, auto-login as 'student' (for single-node dev)
  # - dummy: Accept any username/password (for testing)
  # - github: GitHub OAuth authentication
  # - multi: GitHub OAuth + Local accounts
  authMode: "auto-login"

  # Auto-create admin user on first install
  adminUser:
    enabled: false

  # ============================================================================
  # Git Repository Cloning
  # ============================================================================
  # Users can provide an optional Git URL on the spawn form; the repo will be
  # cloned into ~/home at container start via an init container.
  gitClone:
    # Container image used for git operations (must include git and sh)
    initContainerImage: "alpine/git:2.47.2"
    # Allowed Git hosting providers (subdomains are also accepted)
    allowedProviders:
      - github.com
      - gitlab.com
      - bitbucket.org
    # Maximum time (seconds) allowed for a clone or fetch operation
    maxCloneTimeout: 300

  # ============================================================================
  # Accelerator Configuration
  # ============================================================================
  # Define available GPU/NPU node types for course selection interface
  accelerators:
    phx:
      displayName: "AMD Radeon™ 780M (Phoenix Point iGPU)"
      description: "RDNA 3.0 (gfx1103) | Compute Units 12 | 4GB LPDDR5X"
      nodeSelector:
        node-type: phx
      env:
        HSA_OVERRIDE_GFX_VERSION: "11.0.0"
      quotaRate: 2
    strix:
      displayName: "AMD Radeon™ 890M (Strix Point iGPU)"
      description: "RDNA 3.5 (gfx1150) | Compute Units 16 | 4GB LPDDR5X"
      nodeSelector:
        node-type: strix
      env: {}
      quotaRate: 2
    strix-halo:
      displayName: "AMD Radeon™ 8060S (Strix Halo iGPU)"
      description: "RDNA 3.5 (gfx1151) | Compute Units 40 | 64GB LPDDR5X"
      nodeSelector:
        node-type: strix-halo
      env: {}
      quotaRate: 3
    dgpu:
      displayName: "AMD Radeon™ 9070XT (Desktop GPU)"
      description: "RDNA 4.0 (gfx1201) | Compute Units 64 | 16GB GDDR6"
      nodeSelector:
        node-type: dgpu
      env: {}
      quotaRate: 4
    strix-npu:
      displayName: "AMD XDNA2 (Strix Point NPU)"
      description: "AMD XDNA2 NPU with AI acceleration"
      nodeSelector:
        type: strix
      env: {}
      quotaRate: 1

  # ============================================================================
  # Course Resources Configuration
  # ============================================================================
  resources:
    # Course Images
    # Add new course images here
    images:
      cpu: "ghcr.io/amdresearch/auplc-default:latest"
      Course-CV: "ghcr.io/amdresearch/auplc-cv:latest"
      Course-DL: "ghcr.io/amdresearch/auplc-dl:latest"
      Course-LLM: "ghcr.io/amdresearch/auplc-llm:latest"
      Course-PhySim: "ghcr.io/amdresearch/auplc-physim:latest"
      # Custom-URL: "ghcr.io/amdresearch/auplc-cv:latest"

    # Course Resource Requirements
    # Define resource quotas for each course
    requirements:
      cpu:
        cpu: "2"
        memory: "4Gi"
        memory_limit: "6Gi"
      Course-CV:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      Course-DL:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      Course-LLM:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      Course-PhySim:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      # Custom-URL:
      #   cpu: "4"
      #   memory: "16Gi"
      #   memory_limit: "24Gi"
      #   amd.com/gpu: "1"
      none:
        cpu: "2"
        memory: "4Gi"
        memory_limit: "6Gi"

    # Course Metadata (for spawn UI)
    # Defines display information for each course
    metadata:
      cpu:
        group: "OTHERS"
        description: "Basic Python Environment"
        subDescription: "CPU Only Environment"
        accelerator: ""
        acceleratorKeys: []
      Course-CV:
        group: "COURSE"
        description: "Computer Vision Course"
        subDescription: "Suitable for CV experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - strix-halo
      Course-DL:
        group: "COURSE"
        description: "Deep Learning Course"
        subDescription: "Suitable for DL experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - strix-halo
      Course-LLM:
        group: "COURSE"
        description: "Large Language Models Course"
        subDescription: "Suitable for LLM experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - strix-halo
      Course-PhySim:
        group: "COURSE"
        description: "Genesis Physical Simulation Course"
        subDescription: "Suitable for physical simulation experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - strix-halo

  # ============================================================================
  # Team Permission Configuration
  # ============================================================================
  # Define which teams can access which courses
  teams:
    mapping:
      cpu:
        - cpu
      gpu:
        - Course-CV
        - Course-DL
        - Course-LLM
        - Course-PhySim
      official:
        - cpu
        - Course-CV
        - Course-DL
        - Course-LLM
        - Course-PhySim
      AUP:
        - Course-CV
        - Course-DL
        - Course-LLM
        - Course-PhySim
      native-users:
        - Course-CV
        - Course-DL
        - Course-LLM

  # ============================================================================
  # Quota Management
  # ============================================================================
  quota:
    # Enable quota system (auto-disabled for auto-login/dummy modes if not set)
    enabled: null
    # CPU-only quota consumption rate
    cpuRate: 1
    # Minimum quota required to start any container
    minimumToStart: 10
    # Default quota for new users (0 = no initial allocation)
    defaultQuota: 0
    # Auto-refresh rules: each rule generates a K8s CronJob
    refreshRules: {}

# Use K3s built-in local-path storage (no NFS required)
hub:
  db:
    pvc:
      storageClassName: local-path
  image:
    name: ghcr.io/amdresearch/auplc-hub
    tag: latest
    pullPolicy: IfNotPresent

  # Additional Python config snippets (executed after core/setup.py)
  # Example:
  #   myconfig: |
  #     c.JupyterHub.some_setting = "value"
  extraConfig: {}

  extraFiles:
    announcement.txt:
    # If you want to edit the notice on login.html, change here.
      mountPath: /usr/local/share/jupyterhub/static/announcement.txt
      stringData: |
          <div class="announcement-box" style="padding: 1em; border: 1px solid #ccc; border-radius: 6px; background-color: #f8f8f8;">
          <h3>Welcome to AUP Learning Cloud!</h3>
          <p>This is a <strong>dynamic announcement</strong>.</p>
          <p>My location is on <code>runtime/values.yaml</code></p>
          <p>You can edit this via <strong>ConfigMap</strong> without rebuilding the image.</p>
          </div>

  config:
    # ---- Hub Core ----
    # JupyterHub:
      # Enable JupyterHub REST API
      # API Documentation: https://jupyterhub.readthedocs.io/en/stable/reference/rest-api.html
      # api_tokens:
      #   Configure API tokens for external services
      #   Format: token: username
      #   It's recommended to use environment variables or secrets to manage tokens
      #   Example: "your-secure-api-token-here": "admin-service"

    Authenticator:
      allow_all: true

    # ---- GitHub OAuth ----
    GitHubOAuthenticator:
      oauth_callback_url: "https://<Your.domain>/hub/github/oauth_callback"
      client_id: "TODO"
      client_secret: "TODO"
      allowed_organizations:
        - <YOUR-ORG-NAME>
      scope:
        - read:user
        - read:org

    # ---- KubeSpawner Prepuller Setup ----
    KubeSpawner:
      image_pull_policy: IfNotPresent

singleuser:
  storage:
    dynamic:
      storageClass: local-path

# Use NodePort for direct access
proxy:
  service:
    type: NodePort
    nodePorts:
      http: 30890

# Disable ingress (use NodePort instead)
ingress:
  enabled: false

# Disable prePuller for faster deployment
# Images will be pulled on-demand when users spawn notebooks
prePuller:
  hook:
    enabled: false
  continuous:
    enabled: false
