# Modifications Copyright (C) 2025 Advanced Micro Devices, Inc. All rights reserved.
# Portions of this file consist of AI-generated content.
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

# Multi-Node Deployment Values
# Copy this file and customize for your environment:
#   cp values-multi-nodes.yaml.example values-multi-nodes.yaml
#
# Deploy with:
#   helm install jupyterhub ./chart -n jupyterhub --create-namespace \
#     -f values.yaml -f values-multi-nodes.yaml

# ============================================================================
# Course Management Guide
# ============================================================================
# Add a new course:
#   1. Add course image in custom.resources.images
#   2. Add resource requirements in custom.resources.requirements
#   3. Add course metadata in custom.resources.metadata
#   4. Add team access permissions in custom.teams.mapping
#
# Modify a course:
#   - Change image address or tag in images
#   - Adjust CPU/memory/GPU settings in requirements
#
# Add a new accelerator:
#   - Add new GPU/NPU node type in custom.accelerators
# ============================================================================

custom:
  # Authentication mode: "auto-login" | "dummy" | "github" | "multi"
  #   - auto-login: No credentials required, auto-login as 'student' (for single-node dev)
  #   - dummy: Accept any username/password (for testing)
  #   - github: GitHub OAuth authentication
  #   - multi: GitHub OAuth + Local accounts
  authMode: "multi"

  # GitHub organization name for team-based resource access
  githubOrgName: "your-github-org"

  # Auto-create admin user on first install
  adminUser:
    enabled: false

  # --------------------------------------------------------------------------
  # Git Repository Cloning
  # --------------------------------------------------------------------------
  # Users can provide an optional Git URL on the spawn form; the repo will be
  # cloned into ~/home at container start via an init container.
  #
  # Private repo access — two independent mechanisms (can be used together):
  #   1. GitHub App (githubAppName) — per-repo read-only access for OAuth users
  #   2. Default Access Token (defaultAccessToken) — admin PAT for all users
  #
  # Token priority: OAuth token (GitHub App) > defaultAccessToken > none
  gitClone:
    githubAppName: ""
    defaultAccessToken: ""
    allowedProviders:
      - github.com
      - gitlab.com
      - bitbucket.org

  # --------------------------------------------------------------------------
  # Accelerator Configuration
  # --------------------------------------------------------------------------
  accelerators:
    igpu:
      displayName: "AMD Radeon™ 890M (Strix Point iGPU)"
      description: "RDNA 3.5 (gfx1150) | Compute Units 16 | 4GB LPDDR5X"
      nodeSelector:
        node-type: strix
      env: {}
      quotaRate: 2
    dgpu:
      displayName: "AMD Radeon™ 9070XT (Desktop GPU)"
      description: "RDNA 4.0 (gfx1201) | Compute Units 64 | 16GB GDDR6"
      nodeSelector:
        node-type: dgpu
      env: {}
      quotaRate: 4

  # --------------------------------------------------------------------------
  # Course Resources
  # --------------------------------------------------------------------------
  resources:
    images:
      cpu: "ghcr.io/your-org/cpu-notebook:latest"
      Course-CV: "ghcr.io/your-org/course-cv:latest"
      Course-DL: "ghcr.io/your-org/course-dl:latest"

    requirements:
      cpu:
        cpu: "2"
        memory: "4Gi"
        memory_limit: "6Gi"
      Course-CV:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      Course-DL:
        cpu: "4"
        memory: "16Gi"
        memory_limit: "24Gi"
        amd.com/gpu: "1"
      none:
        cpu: "2"
        memory: "4Gi"
        memory_limit: "6Gi"

    metadata:
      cpu:
        group: "CUSTOM REPO"
        description: "Basic Python Environment"
        subDescription: "CPU Only Environment"
        accelerator: ""
        acceleratorKeys: []
        allowGitClone: true
      Course-CV:
        group: "COURSE"
        description: "Computer Vision Course"
        subDescription: "Suitable for CV experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - igpu
          - dgpu
      Course-DL:
        group: "COURSE"
        description: "Deep Learning Course"
        subDescription: "Suitable for DL experiments with GPU"
        accelerator: "GPU"
        acceleratorKeys:
          - igpu
          - dgpu

  # --------------------------------------------------------------------------
  # Team Permission Configuration
  # --------------------------------------------------------------------------
  teams:
    mapping:
      gpu:
        - Course-CV
        - Course-DL
      official:
        - cpu
        - Course-CV
        - Course-DL
      native-users:
        - cpu
        - Course-CV
        - Course-DL

  # Local accounts for multi auth mode (pattern supports ranges like {01-50})
  # localAccounts:
  #   CLASS-A:
  #     pattern: "STUDENT{01-30}"
  #     password: "ChangeMe@2025"
  #     courses:
  #       - Course-CV
  #       - Course-DL

  # --------------------------------------------------------------------------
  # Quota Management
  # --------------------------------------------------------------------------
  quota:
    enabled: null  # auto-disabled for auto-login/dummy modes
    cpuRate: 1
    minimumToStart: 10
    defaultQuota: 0
    refreshRules: {}

# ============================================================================
# Hub Configuration
# ============================================================================
hub:
  db:
    pvc:
      storageClassName: nfs-client
  image:
    name: ghcr.io/amdresearch/auplc-hub
    tag: latest
    pullPolicy: IfNotPresent
    pullSecrets:
      - github-registry-secret

  extraFiles:
    announcement.txt:
      mountPath: /usr/local/share/jupyterhub/static/announcement.txt
      stringData: |
          <div class="announcement-box" style="padding: 1em; border: 1px solid #ccc; border-radius: 6px; background-color: #f8f8f8;">
          <h3>Welcome to AUP Learning Cloud!</h3>
          <p>Edit this announcement in <code>values-multi-nodes.yaml</code></p>
          </div>

  config:
    Authenticator:
      allow_all: true
      admin_users:
        - your-github-username

    # GitHub App OAuth (replaces legacy OAuth App)
    # Create at: https://github.com/organizations/<YOUR-ORG>/settings/apps/new
    # Permissions: Contents (read-only), Members (read-only)
    # Webhook: off
    GitHubOAuthenticator:
      oauth_callback_url: "https://your.domain.com/hub/github/oauth_callback"
      client_id: "TODO"
      client_secret: "TODO"
      allowed_organizations:
        - your-github-org
      scope: []

    KubeSpawner:
      image_pull_policy: IfNotPresent
      image_pull_secrets:
        - github-registry-secret

singleuser:
  storage:
    dynamic:
      storageClass: nfs-client

# Use ClusterIP + Ingress for production domains
proxy:
  service:
    type: ClusterIP
    nodePorts:
      http: null
      https: null

# If using Ingress (recommended for production)
# ingress:
#   enabled: true
#   ingressClassName: traefik  # or nginx
#   hosts:
#     - your.domain.com
#   tls:
#     - hosts:
#         - your.domain.com
#       secretName: jupyter-tls-cert

# If not using Ingress, use NodePort instead:
# proxy:
#   service:
#     type: NodePort
#     nodePorts:
#       http: 30890

imagePullSecrets:
  - github-registry-secret

# Pre-pull images for faster startup
prePuller:
  extraImages:
    aup-cpu-notebook:
      name: ghcr.io/amdresearch/aup-cpu-notebook
      tag: v1.0
    aup-course-cv:
      name: ghcr.io/amdresearch/auplc-cv
      tag: v1.0
    aup-course-dl:
      name: ghcr.io/amdresearch/auplc-dl
      tag: v1.0
    aup-course-llm:
      name: ghcr.io/amdresearch/auplc-llm
      tag: v1.0
    aup-jupyterhub-hub:
      name: ghcr.io/amdresearch/auplc-hub
      tag: v0.1
