{{- /*
  CronJob template for quota auto-refresh.
  Iterates over custom.quota.refreshRules and creates a CronJob for each enabled rule.
*/}}
{{- $root := . -}}
{{- if .Values.custom.quota.refreshRules }}
{{- range $ruleName, $rule := .Values.custom.quota.refreshRules }}
{{- if $rule.enabled }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "jupyterhub.hub.fullname" $root }}-quota-{{ $ruleName }}
  labels:
    {{- include "jupyterhub.labels" $root | nindent 4 }}
    app.kubernetes.io/component: quota-refresh
    quota-refresh-rule: {{ $ruleName }}
spec:
  schedule: {{ $rule.schedule | quote }}
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            {{- include "jupyterhub.labels" $root | nindent 12 }}
            app.kubernetes.io/component: quota-refresh
            quota-refresh-rule: {{ $ruleName }}
            hub.jupyter.org/network-access-hub: "true"
        spec:
          restartPolicy: OnFailure
          containers:
          - name: quota-refresh
            image: curlimages/curl:8.5.0
            command:
            - /bin/sh
            - -c
            - |
              echo "Running quota refresh rule: {{ $ruleName }} (action: {{ $rule.action | default "add" }})"
              curl -sf -X POST "http://{{ include "jupyterhub.hub.fullname" $root }}:8081/hub/admin/api/quota/refresh" \
                -H "Authorization: token ${JUPYTERHUB_API_TOKEN}" \
                -H "Content-Type: application/json" \
                -d '{{ dict "rule_name" $ruleName "action" ($rule.action | default "add") "amount" ($rule.amount | default 100) "max_balance" $rule.maxBalance "min_balance" $rule.minBalance "targets" ($rule.targets | default dict) | toJson }}' \
                && echo "Quota refresh completed successfully"
            env:
            - name: JUPYTERHUB_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ include "jupyterhub.hub.fullname" $root }}
                  key: hub.services.quota-refresh.apiToken
                  optional: false
{{- end }}
{{- end }}
{{- end }}
