# Copyright (C) 2025 Advanced Micro Devices, Inc. All rights reserved.
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

name: Build Docker Images

on:
  push:
    branches: [main, develop]
    tags: ['v*']
    paths:
      - 'dockerfiles/**'
      - 'runtime/hub/**'
      - 'projects/**'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'dockerfiles/**'
      - 'runtime/hub/**'
      - 'projects/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for images (e.g. v1.2.0)'
        required: false
        default: ''
      images:
        description: 'Which images to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - hub
          - courses
          - base-cpu
          - base-gpu

# Prevent duplicate builds on the same branch / PR
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write

jobs:
  # ──────────────────────────────────────────────
  # Detect which files changed to decide what to build
  # ──────────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      hub: ${{ steps.filter.outputs.hub }}
      base-cpu: ${{ steps.filter.outputs.base-cpu }}
      base-gpu: ${{ steps.filter.outputs.base-gpu }}
      course-matrix: ${{ steps.matrix.outputs.matrix }}
      course-any: ${{ steps.matrix.outputs.any }}
      registry: ${{ steps.registry.outputs.prefix }}
      is-tag: ${{ steps.check.outputs.is-tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Set registry prefix
        id: registry
        run: echo "prefix=ghcr.io/$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Check if tag push
        id: check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "is-tag=true" >> "$GITHUB_OUTPUT"
          else
            echo "is-tag=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: dorny/paths-filter@v3
        if: github.ref_type != 'tag'
        id: filter
        with:
          filters: |
            hub:
              - 'dockerfiles/Hub/**'
              - 'runtime/hub/**'
            base-cpu:
              - 'dockerfiles/Base/Dockerfile.cpu'
            base-gpu:
              - 'dockerfiles/Base/Dockerfile.gfx1151'
            course-cv:
              - 'dockerfiles/Courses/CV/**'
              - 'projects/CV/**'
            course-dl:
              - 'dockerfiles/Courses/DL/**'
              - 'projects/DL/**'
            course-llm:
              - 'dockerfiles/Courses/LLM/**'
              - 'projects/LLM/**'
            course-physim:
              - 'dockerfiles/Courses/PhySim/**'
              - 'projects/PhySim/**'

      - name: Build course matrix
        id: matrix
        run: |
          # For tags or workflow_dispatch(all/courses): build all courses
          # For push/PR: build only changed courses (+ all if base-gpu changed)
          BUILD_ALL="false"
          if [[ "${{ steps.check.outputs.is-tag }}" == "true" ]]; then
            BUILD_ALL="true"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.images }}" == "all" || "${{ github.event.inputs.images }}" == "courses" ]]; then
              BUILD_ALL="true"
            fi
          elif [[ "${{ steps.filter.outputs.base-gpu }}" == "true" ]]; then
            BUILD_ALL="true"
          fi

          matrix='[]'
          if [[ "$BUILD_ALL" == "true" || "${{ steps.filter.outputs.course-cv }}" == "true" ]]; then
            matrix=$(echo "$matrix" | jq -c '. + [{"course":"CV","image_suffix":"auplc-cv","prepare":"cp -r projects/CV dockerfiles/Courses/CV/course_data"}]')
          fi
          if [[ "$BUILD_ALL" == "true" || "${{ steps.filter.outputs.course-dl }}" == "true" ]]; then
            matrix=$(echo "$matrix" | jq -c '. + [{"course":"DL","image_suffix":"auplc-dl","prepare":"cp -r projects/DL dockerfiles/Courses/DL/course_data"}]')
          fi
          if [[ "$BUILD_ALL" == "true" || "${{ steps.filter.outputs.course-llm }}" == "true" ]]; then
            matrix=$(echo "$matrix" | jq -c '. + [{"course":"LLM","image_suffix":"auplc-llm","prepare":"cp -r projects/LLM dockerfiles/Courses/LLM/LLM"}]')
          fi
          if [[ "$BUILD_ALL" == "true" || "${{ steps.filter.outputs.course-physim }}" == "true" ]]; then
            matrix=$(echo "$matrix" | jq -c '. + [{"course":"PhySim","image_suffix":"auplc-physim","prepare":"cp -r projects/PhySim dockerfiles/Courses/PhySim/course_data"}]')
          fi

          echo "matrix={\"include\":$matrix}" >> "$GITHUB_OUTPUT"
          if [[ "$matrix" != "[]" ]]; then
            echo "any=true" >> "$GITHUB_OUTPUT"
          else
            echo "any=false" >> "$GITHUB_OUTPUT"
          fi

  # ──────────────────────────────────────────────
  # Hub Image (CPU only, runs on GitHub Actions)
  # ──────────────────────────────────────────────
  build-hub:
    name: Build Hub Image
    needs: changes
    if: |
      needs.changes.outputs.is-tag == 'true' ||
      needs.changes.outputs.hub == 'true' ||
      github.event_name == 'workflow_dispatch' && (github.event.inputs.images == 'all' || github.event.inputs.images == 'hub')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.changes.outputs.registry }}/auplc-hub
          tags: |
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=semver,pattern=v{{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push Hub image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: dockerfiles/Hub/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=hub
          cache-to: type=gha,mode=max,scope=hub
          provenance: false

  # ──────────────────────────────────────────────
  # Base CPU Image (runs on GitHub Actions)
  # ──────────────────────────────────────────────
  build-base-cpu:
    name: Build Base CPU Image
    needs: changes
    if: |
      needs.changes.outputs.is-tag == 'true' ||
      needs.changes.outputs.base-cpu == 'true' ||
      github.event_name == 'workflow_dispatch' && (github.event.inputs.images == 'all' || github.event.inputs.images == 'base-cpu')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.changes.outputs.registry }}/auplc-default
          tags: |
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push Base CPU image
        uses: docker/build-push-action@v6
        with:
          context: dockerfiles/Base
          file: dockerfiles/Base/Dockerfile.cpu
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=base-cpu
          cache-to: type=gha,mode=max,scope=base-cpu
          provenance: false

  # ──────────────────────────────────────────────
  # Base GPU Image (gfx1151)
  #
  # No GPU hardware required — only downloads ROCm tarball + pip wheels.
  # Uses free-disk-space action to reclaim runner disk for the large image.
  # ──────────────────────────────────────────────
  build-base-gpu:
    name: Build Base GPU Image (gfx1151)
    needs: changes
    if: |
      needs.changes.outputs.is-tag == 'true' ||
      needs.changes.outputs.base-gpu == 'true' ||
      github.event_name == 'workflow_dispatch' && (github.event.inputs.images == 'all' || github.event.inputs.images == 'base-gpu')
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.out.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.changes.outputs.registry }}/base-gfx1151
          tags: |
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push Base GPU image
        uses: docker/build-push-action@v6
        with:
          context: dockerfiles/Base
          file: dockerfiles/Base/Dockerfile.gfx1151
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=base-gpu
          cache-to: type=gha,mode=max,scope=base-gpu
          provenance: false

      - name: Export first image tag for downstream jobs
        if: github.event_name != 'pull_request'
        id: out
        run: echo "image=$(echo '${{ steps.meta.outputs.tags }}' | head -1)" >> "$GITHUB_OUTPUT"

  # ──────────────────────────────────────────────
  # Course Images (CV, DL, LLM, PhySim)
  #
  # These images use `FROM ghcr.io/amdresearch/base-gfx1151:v0.1-full`
  # which is pre-built and pushed to GHCR. The build itself only copies
  # files and installs pip packages — no GPU required.
  #
  # BASE_IMAGE build-arg overrides the default so course images
  # can track the latest GPU base image version from CI.
  # ──────────────────────────────────────────────
  build-courses:
    name: "Build Course: ${{ matrix.course }}"
    needs: [changes, build-base-gpu]
    if: |
      always() &&
      needs.changes.result == 'success' &&
      needs.changes.outputs.course-any == 'true' &&
      (needs.build-base-gpu.result == 'success' || needs.build-base-gpu.result == 'skipped')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.changes.outputs.course-matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build context
        run: ${{ matrix.prepare }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.changes.outputs.registry }}/${{ matrix.image_suffix }}
          tags: |
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=semver,pattern=v{{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}
            type=sha,prefix=sha-
            type=ref,event=branch
            type=ref,event=pr

      - name: Build and push ${{ matrix.course }} image
        uses: docker/build-push-action@v6
        with:
          context: dockerfiles/Courses/${{ matrix.course }}
          file: dockerfiles/Courses/${{ matrix.course }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ${{ needs.build-base-gpu.outputs.image && format('BASE_IMAGE={0}', needs.build-base-gpu.outputs.image) || '' }}
          cache-from: type=gha,scope=course-${{ matrix.course }}
          cache-to: type=gha,mode=max,scope=course-${{ matrix.course }}
          provenance: false
